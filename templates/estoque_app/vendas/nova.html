{% extends 'base.html' %}

{% block title %}Nova Venda - PDV{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <h1 class="text-xl font-semibold text-gray-900">Nova Venda - PDV</h1>
                <div class="flex space-x-3">
                    <a href="{% url 'estoque_app:produto_list' %}"
                       class="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-300 transition-colors">
                        Voltar para Produtos
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Formulário de Adicionar Item -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Adicionar Item</h2>
                    
                    <form id="formAdicionarItem" class="space-y-4">
                        <!-- Código do Produto -->
                        <div>
                            <label for="codigo_produto" class="block text-sm font-medium text-gray-700 mb-2">
                                Código do Produto <span class="text-red-500">*</span>
                            </label>
                            <div class="flex space-x-2">
                                <input type="text" id="codigo_produto" 
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-base"
                                       placeholder="Digite o código">
                                <button type="button" id="btnBuscarProduto"
                                        class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500">
                                    Buscar
                                </button>
                            </div>
                            <p id="mensagemBusca" class="mt-1 text-sm text-gray-500"></p>
                        </div>
                        
                        <!-- Nome do Produto (readonly) -->
                        <div>
                            <label for="nome_produto" class="block text-sm font-medium text-gray-700 mb-2">
                                Nome do Produto
                            </label>
                            <input type="text" id="nome_produto" readonly
                                   class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-50 text-base"
                                   placeholder="Busque um produto primeiro">
                        </div>
                        
                        <!-- Valor Unitário (readonly) -->
                        <div>
                            <label for="valor_unitario" class="block text-sm font-medium text-gray-700 mb-2">
                                Valor Unitário
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-lg">R$</span>
                                <input type="text" id="valor_unitario" readonly
                                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md bg-gray-50 text-base"
                                       placeholder="0.00">
                            </div>
                        </div>
                        
                        <!-- Quantidade -->
                        <div>
                            <label for="quantidade" class="block text-sm font-medium text-gray-700 mb-2">
                                Quantidade <span class="text-red-500">*</span>
                            </label>
                            <input type="number" id="quantidade" min="1" value="1"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-base">
                        </div>
                        
                        <!-- Valor Total do Item (readonly) -->
                        <div>
                            <label for="valor_total_item" class="block text-sm font-medium text-gray-700 mb-2">
                                Valor Total do Item
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-lg">R$</span>
                                <input type="text" id="valor_total_item" readonly
                                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md bg-gray-50 text-base font-semibold"
                                       placeholder="0.00">
                            </div>
                        </div>
                        
                        <!-- Botão Adicionar -->
                        <button type="submit" id="btnAdicionarItem"
                                class="w-full px-6 py-3 bg-primary-600 text-white text-base font-medium rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
                            Adicionar à Venda
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Tabela da Venda -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Itens da Venda</h2>
                    
                    <!-- Tabela -->
                    <div class="overflow-x-auto mb-6">
                        <table class="min-w-full divide-y divide-gray-200" id="tabelaItens">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Código</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Valor Unitário</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Quantidade</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Valor Total</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyItens" class="bg-white divide-y divide-gray-200">
                                <tr id="linhaVazia">
                                    <td colspan="6" class="px-6 py-8 text-center text-sm text-gray-500">
                                        Nenhum item adicionado. Adicione produtos à venda.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Total da Venda -->
                    <div class="border-t border-gray-200 pt-4">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-semibold text-gray-900">Total da Venda:</span>
                            <span class="text-2xl font-bold text-primary-600" id="totalVenda">R$ 0,00</span>
                        </div>
                    </div>
                    
                    <!-- Botão Finalizar Venda -->
                    <div class="mt-6">
                        <button type="button" id="btnFinalizarVenda"
                                class="w-full px-6 py-4 bg-green-600 text-white text-lg font-medium rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                                disabled>
                            Finalizar Venda
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
// Função para obter CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Estado da venda
let itensVenda = [];
let produtoAtual = null;

// Elementos do DOM
const codigoInput = document.getElementById('codigo_produto');
const btnBuscar = document.getElementById('btnBuscarProduto');
const mensagemBusca = document.getElementById('mensagemBusca');
const nomeInput = document.getElementById('nome_produto');
const valorUnitarioInput = document.getElementById('valor_unitario');
const quantidadeInput = document.getElementById('quantidade');
const valorTotalItemInput = document.getElementById('valor_total_item');
const btnAdicionar = document.getElementById('btnAdicionarItem');
const tbodyItens = document.getElementById('tbodyItens');
const linhaVazia = document.getElementById('linhaVazia');
const totalVendaSpan = document.getElementById('totalVenda');
const btnFinalizar = document.getElementById('btnFinalizarVenda');

// Buscar produto por código
btnBuscar.addEventListener('click', async () => {
    const codigo = codigoInput.value.trim();
    
    if (!codigo) {
        mensagemBusca.textContent = 'Digite um código';
        mensagemBusca.className = 'mt-1 text-sm text-red-500';
        return;
    }
    
    try {
        mensagemBusca.textContent = 'Buscando...';
        mensagemBusca.className = 'mt-1 text-sm text-blue-500';
        
        const response = await fetch('{% url "estoque_app:venda_nova" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                acao: 'buscar_produto',
                codigo: codigo
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            produtoAtual = data;
            nomeInput.value = data.nome || '';
            valorUnitarioInput.value = parseFloat(data.valor_unitario || 0).toFixed(2);
            quantidadeInput.value = 1;
            calcularValorTotalItem();
            mensagemBusca.textContent = `Estoque: ${data.quantidade_disponivel}`;
            mensagemBusca.className = 'mt-1 text-sm text-green-500';
        } else {
            produtoAtual = null;
            nomeInput.value = '';
            valorUnitarioInput.value = '';
            quantidadeInput.value = 1;
            valorTotalItemInput.value = '';
            mensagemBusca.textContent = data.erro || 'Produto não encontrado';
            mensagemBusca.className = 'mt-1 text-sm text-red-500';
        }
    } catch (error) {
        mensagemBusca.textContent = 'Erro ao buscar produto';
        mensagemBusca.className = 'mt-1 text-sm text-red-500';
        console.error(error);
    }
});

// Calcular valor total do item
function calcularValorTotalItem() {
    const quantidade = parseFloat(quantidadeInput.value) || 0;
    const valorUnitario = parseFloat(valorUnitarioInput.value) || 0;
    const valorTotal = quantidade * valorUnitario;
    valorTotalItemInput.value = valorTotal.toFixed(2);
}

quantidadeInput.addEventListener('input', calcularValorTotalItem);

// Adicionar item à venda
btnAdicionar.addEventListener('click', (e) => {
    e.preventDefault();
    
    if (!produtoAtual) {
        alert('Busque um produto primeiro');
        return;
    }
    
    const quantidade = parseInt(quantidadeInput.value) || 0;
    
    if (quantidade <= 0) {
        alert('Quantidade deve ser maior que zero');
        return;
    }
    
    if (quantidade > produtoAtual.quantidade_disponivel) {
        alert(`Estoque insuficiente. Disponível: ${produtoAtual.quantidade_disponivel}`);
        return;
    }
    
    // Adiciona item à lista
    const item = {
        produto_id: produtoAtual.id,
        codigo: produtoAtual.codigo,
        nome: produtoAtual.nome,
        valor_unitario: parseFloat(produtoAtual.valor_unitario),
        quantidade: quantidade
    };
    
    itensVenda.push(item);
    
    // Limpa formulário
    codigoInput.value = '';
    nomeInput.value = '';
    valorUnitarioInput.value = '';
    quantidadeInput.value = 1;
    valorTotalItemInput.value = '';
    produtoAtual = null;
    mensagemBusca.textContent = '';
    
    // Atualiza tabela
    atualizarTabela();
    atualizarTotal();
});

// Atualizar tabela de itens
function atualizarTabela() {
    if (itensVenda.length === 0) {
        linhaVazia.style.display = '';
        return;
    }
    
    linhaVazia.style.display = 'none';
    
    tbodyItens.innerHTML = itensVenda.map((item, index) => {
        const valorTotal = item.valor_unitario * item.quantidade;
        return `
            <tr>
                <td class="px-4 py-3 text-sm text-gray-900">${item.codigo}</td>
                <td class="px-4 py-3 text-sm text-gray-900">${item.nome}</td>
                <td class="px-4 py-3 text-sm text-gray-900 text-right">R$ ${item.valor_unitario.toFixed(2)}</td>
                <td class="px-4 py-3 text-sm text-gray-900 text-right">${item.quantidade}</td>
                <td class="px-4 py-3 text-sm font-medium text-gray-900 text-right">R$ ${valorTotal.toFixed(2)}</td>
                <td class="px-4 py-3 text-sm text-center">
                    <button onclick="removerItem(${index})" class="text-red-600 hover:text-red-900">
                        Remover
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Remover item
window.removerItem = function(index) {
    itensVenda.splice(index, 1);
    atualizarTabela();
    atualizarTotal();
};

// Atualizar total da venda
function atualizarTotal() {
    const total = itensVenda.reduce((sum, item) => {
        return sum + (item.valor_unitario * item.quantidade);
    }, 0);
    
    totalVendaSpan.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
    btnFinalizar.disabled = itensVenda.length === 0;
}

// Finalizar venda
btnFinalizar.addEventListener('click', async () => {
    if (itensVenda.length === 0) {
        alert('Adicione pelo menos um item à venda');
        return;
    }
    
    if (!confirm(`Confirmar venda de ${itensVenda.length} item(ns)?`)) {
        return;
    }
    
    try {
        btnFinalizar.disabled = true;
        btnFinalizar.textContent = 'Processando...';
        
        const response = await fetch('{% url "estoque_app:venda_nova" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                acao: 'finalizar_venda',
                itens: itensVenda
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.sucesso) {
            // Redireciona para página de confirmação
            window.location.href = `/vendas/${data.venda_id}/confirmacao/`;
        } else {
            alert(data.erro || 'Erro ao finalizar venda');
            btnFinalizar.disabled = false;
            btnFinalizar.textContent = 'Finalizar Venda';
        }
    } catch (error) {
        alert('Erro ao finalizar venda');
        btnFinalizar.disabled = false;
        btnFinalizar.textContent = 'Finalizar Venda';
        console.error(error);
    }
});

// Permitir buscar com Enter
codigoInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        btnBuscar.click();
    }
});
</script>
{% endblock %}
